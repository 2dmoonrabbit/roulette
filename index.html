<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>레몬 룰렛</title>
  <style>
    :root { --size: 360px; }
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      background:#0f1220; color:#fff;
    }
    .wrap{ display:flex; flex-direction:column; align-items:center; gap:14px; padding:24px; }
    .wheel-wrap{ position:relative; width:var(--size); height:var(--size); }
    canvas{ width:100%; height:100%; border-radius:50%; box-shadow:0 14px 45px rgba(0,0,0,.45); }
    .pin{
      position:absolute; top:-12px; left:50%; transform:translateX(-50%);
      width:0; height:0;
      border-left:12px solid transparent;
      border-right:12px solid transparent;
      border-bottom:22px solid #ffffff;
      filter: drop-shadow(0 8px 14px rgba(0,0,0,.45));
    }
    button{
      padding:12px 18px; border:0; border-radius:14px; cursor:pointer;
      font-weight:800; font-size:16px; background:#fff; color:#111;
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .result{ font-size:18px; font-weight:800; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="wheel-wrap">
      <div class="pin"></div>
      <canvas id="wheel" width="720" height="720"></canvas>
    </div>

    <button id="spinBtn" disabled>SPIN</button>
    <div class="result" id="result">결과: -</div>
  </div>

<script>
  const outcomes = [
    { label: "x3",  p: 3  },
    { label: "x2",  p: 5  },
    { label: "x0",  p: 10 },
    { label: "x1",  p: 80 },
    { label: "x-2", p: 2  },
  ];

  const IMAGE_ZOOM = 1.00;

  const canvas = document.getElementById("wheel");
  const ctx = canvas.getContext("2d");
  const spinBtn = document.getElementById("spinBtn");
  const resultEl = document.getElementById("result");

  const W = canvas.width, H = canvas.height;
  const cx = W/2, cy = H/2;
  const r  = Math.min(W,H)/2 - 18;

  const wheelImg = new Image();
  wheelImg.src = "lemon.png";

  wheelImg.onload = () => {
    draw(angle);
    spinBtn.disabled = false;
  };

  const totalP = outcomes.reduce((a,b)=>a+b.p,0);
  const sectors = [];
  let acc = 0;
  const startBase = -Math.PI / 2;

  for (let i=0; i<outcomes.length; i++){
    const span = (outcomes[i].p / totalP) * Math.PI * 2;
    const start = startBase + acc;
    const end = start + span;
    sectors.push({ i, start, end, mid: (start+end)/2 });
    acc += span;
  }

  function pickSectorIndex(){
    const x = Math.random() * totalP;
    let s = 0;
    for (let i=0;i<outcomes.length;i++){
      s += outcomes[i].p;
      if (x < s) return i;
    }
    return outcomes.length - 1;
  }

  let angle = 0;
  let spinning = false;

  function draw(a){
    ctx.clearRect(0,0,W,H);
    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(a);

    ctx.beginPath();
    ctx.arc(0,0,r,0,Math.PI*2);
    ctx.clip();

    const imgW = wheelImg.width, imgH = wheelImg.height;
    const baseScale = Math.max((r*2)/imgW, (r*2)/imgH);
    const scale = baseScale * IMAGE_ZOOM;
    ctx.drawImage(wheelImg, -imgW*scale/2, -imgH*scale/2, imgW*scale, imgH*scale);

    ctx.fillStyle = "rgba(0,0,0,.10)";
    ctx.fillRect(-r,-r,r*2,r*2);

    ctx.lineWidth = 6;
    ctx.strokeStyle = "rgba(255,255,255,.45)";

    for (const s of sectors){
      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.lineTo(Math.cos(s.start)*r, Math.sin(s.start)*r);
      ctx.stroke();

      ctx.save();
      ctx.rotate(s.mid);
      ctx.textAlign = "center";
      ctx.fillStyle = "#fff";
      ctx.font = "900 44px system-ui";
      ctx.fillText(outcomes[s.i].label, 0, -r*0.62);
      ctx.restore();
    }

    ctx.restore();
  }

  spinBtn.addEventListener("click", () => {
    if (spinning) return;
    spinning = true;
    spinBtn.disabled = true;
    resultEl.textContent = "결과: ...";

    const picked = pickSectorIndex();
    const sec = sectors.find(s => s.i === picked);
    const extraTurns = (6 + Math.floor(Math.random()*2)) * Math.PI * 2;
    const target = extraTurns + (-Math.PI/2 - sec.mid);

    const start = performance.now();
    const dur = 2600;
    const startAngle = angle;

    const easeOut = t => 1 - Math.pow(1-t,3);

    function anim(now){
      const t = Math.min(1, (now - start)/dur);
      angle = startAngle + (target - startAngle) * easeOut(t);
      draw(angle);
      if (t < 1) requestAnimationFrame(anim);
      else{
        spinning = false;
        spinBtn.disabled = false;
        resultEl.textContent = `결과: ${outcomes[picked].label}`;
      }
    }
    requestAnimationFrame(anim);
  });
</script>
</body>
</html>
